<% inline_modal ||= false %>

<% form_state = capture do %>
  <div id="application_response_stream" class="flex flex-col items-center justify-center h-full">
    <%= image_tag "https://cloud-mpvs8batk-hack-club-bot.vercel.app/02x-speed-ezgif.com-gif-maker.gif", class: "w-1/2" %>
    <p class="h1 font-bold">Loading...</p>
  </div>
<% end %>

<div x-data="{ loading: false, inline_modal: <%= inline_modal %> }">
  <% if inline_modal %>
    <div x-show="loading">
      <%= form_state %>
    </div>
  <% end %>

  <div x-show="!loading || !inline_modal">
    <%= form_with url: apply_path, html: { "x-data": "{ contactMethod: 'email' }" }, method: :post, data: { turbo: true } do |form| %>
        <fieldset>
            <legend class="text-xl mb-4">Your organisation</legend>
            <div class="field field--wide">
                <%= form.label :organisation_name, "Organisation name" %>
                <%= form.text_field :organisation_name, required: true %>
            </div>

            <div class="field field--wide">
                <%= form.label :organisation_website, "Organization website" %>
                <%= form.text_field :organisation_website, type: :url %>
                <span class="h5 muted">If you donâ€™t have one yet, you can leave this blank.</span>
            </div>

            <div class="field field--wide">
                <%= form.label :organisation_country, "Primary country of operations" %>
                <%= form.collection_select :organisation_country, Event.countries_for_select, :first, :last, { include_blank: "Select a country" }, required: true %>
            </div>

            <div class="field field--wide">
                <%= form.label :organisation_postal_code %>
                <%= form.text_field :organisation_postal_code, placeholder: "05482" %>
                <span class="h5 muted">If your organization runs online, please put your own postal code.</span>
            </div>

            <div class="field">
                <%= form.label :organisation_transparency, "Transparency mode" %>
                <fieldset class="field--wide field--options w-full max-w-none">
                <%= form.radio_button :organisation_transparency, true, checked: true %>
                <%= form.label :organisation_transparency, value: true, class: "w-full g1", style: "flex-direction: row" do %>
                    <%= inline_icon "explore" %>
                    <strong>Transparent</strong>
                <% end %>

                <%= form.radio_button :organisation_transparency, false %>
                <%= form.label :organisation_transparency, value: false, class: "w-full g1", style: "flex-direction: row" do %>
                    <%= inline_icon "private-fill" %>
                    <strong>Private</strong>
                <% end %>
                </fieldset>

                <span class="h5 muted">
                Transparent accountsâ€™ balances and donations are public.
                You choose who has access to personal details.
                This can be changed later.
                As an example, <%= link_to "Hack Club's finances are transparent", "https://hcb.hackclub.com/hq" %>!
                </span>
            </div>

            <div class="field field--wide">
                <%= form.label :organisation_description, "Tell us about your organization" %>
                <%= form.text_area :organisation_description, placeholder: "We're a high school hackathon!" %>
            </div>

            <div class="field field--wide">
                <%= form.label :referred_by, "Who referred you?" %>
                <%= form.text_field :referred_by, placeholder: "Max" %>
            </div>

            <div class="field field--wide">
                <%= form.label :accommodations, "Accessibility needs" %>
                <%= form.text_field :accommodations, placeholder: "I use a screen reader/I need increased text size during onboarding" %>
                <span class="h5 muted">
                Please specify any accommodations, accessibility needs,
                or other important information so we can support you
                during onboarding and while using HCB.
                </span>
            </div>

            <div class="field">
                <%= form.label :contact_method, "Contact method" %>
                <fieldset class="field--wide field--options w-full max-w-none">
                <%= form.radio_button :contact_method, "email", "x-model": "contactMethod", required: true %>
                <%= form.label :contact_method, value: "email", class: "w-full g1", style: "flex-direction: row" do %>
                    <%= inline_icon "email" %>
                    <strong>Email</strong>
                <% end %>

                <% disable_slack_option = current_user.present? && !current_user.teenager? %>
                <% teenager_option = capture do %>
                    <%= form.radio_button :contact_method, "slack", "x-model": "contactMethod", required: true, disabled: disable_slack_option %>
                    <%= form.label :contact_method, value: "slack", class: "w-full g1", style: "flex-direction: row" do %>
                    <%= inline_icon "slack" %>
                    <strong>Slack</strong>
                    <span class="h6">(Teenagers only!)</span>
                    <% end %>
                <% end %>

                <% if disable_slack_option %>
                    <div class="tooltipped tooltipped--n" aria-label="The Hack Club Slack is teenager-only">
                    <%= teenager_option %>
                    </div>
                <% else %>
                    <%= teenager_option %>
                <% end %>

                </fieldset>
            </div>

            <div class="field field--wide" x-show="contactMethod == 'slack'" x-cloak x-transition.duration.500ms>
                <%= form.label :slack_username, "Slack username" %>
                <%= form.text_field :slack_username %>
            </div>
            </fieldset>

            <% if current_user %>
            <%= render "callout", type: "info", title: "Hi, #{current_user.first_name}! ðŸ‘‹", class: "mt-3 mb-6" do %>
                Since you're logged in, we'll re-use your personal details.
                This includes your name, email, phone number and date of birth we already have on file.
                You can <%= link_to "review them here", my_settings_path %>.
            <% end %>
            <% else %>
            <fieldset class="mt-3">
                <legend class="text-xl mb-4">Personal details</legend>

                <div class="flex w-full g2">
                <div class="field field--wide flex-grow">
                    <%= form.label :first_name, "First name" %>
                    <%= form.text_field :first_name, required: true, placeholder: "Fiona" %>
                </div>

                <div class="field field--wide flex-grow">
                    <%= form.label :last_name, "Last name" %>
                    <%= form.text_field :last_name, required: true, placeholder: "Hackworth" %>
                </div>
                </div>

                <div class="field field--wide">
                <%= form.label :email, "Email" %>
                <%= form.text_field :email, required: true, placeholder: "fiona@malted.dev" %>
                </div>

                <div class="field field--wide">
                <%= form.label :birthday, "Birthday" %>
                <%= form.date_field :birthday %>
                <span class="h5 muted">We need to know if you're a child, for compliance reasons.</span>
                </div>

                <div class="field field--wide">
                <%= form.label :phone, "Phone number" %>
                <%= form.text_field :phone, type: :tel %>
                <span class="h5 muted">Weâ€™ll only use this if we need to get in touch with you urgently.</span>
                </div>
            </fieldset>
            <% end %>

            <section class="modal modal--scroll bg-snow modal--wide pt-8 h2/3" data-behavior="modal" role="dialog" id="success">
              <%= form_state unless inline_modal %>
            </section>

            <%= form.submit "Submit", data: { behavior: inline_modal ? nil : "modal_trigger", modal: inline_modal ? nil : "success", controller: "confetti", action: "click->confetti#party", emojis: ["ðŸ¦", "ðŸ’¸"], disable_with: "Submitting..." }, "x-on:click": "loading = true" %>
    <% end %>
  </div>
</div>
